events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # ë¡œê·¸ ì„¤ì •
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    # gzip ì••ì¶•
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    # ğŸ”„ ë™ì  CORS ì˜¤ë¦¬ì§„ ì²˜ë¦¬ - ê°œë°œ í™˜ê²½ìš©
    # $http_origin ë³€ìˆ˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í—ˆìš©ëœ ì˜¤ë¦¬ì§„ë§Œ ë™ì ìœ¼ë¡œ ì„¤ì •
    map $http_origin $cors_origin {
        default "";
        # ê°œë°œ í™˜ê²½ - localhost í¬íŠ¸ë“¤ í—ˆìš© (3000-3009)
        "~^http://localhost:300[0-9]$" $http_origin;
        # í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ì•„ë˜ì™€ ê°™ì´ ì‹¤ì œ ë„ë©”ì¸ ì‚¬ìš©
        # "https://yourdomain.com" $http_origin;
        # "https://app.yourdomain.com" $http_origin;
    }

    server {
        listen 80;
        server_name localhost;
        
        # âš ï¸ CORS í—¤ë” ì„¤ì • - ê°œë°œ í™˜ê²½ìš© (í”„ë¡œë•ì…˜ì—ì„œëŠ” ìˆ˜ì • í•„ìš”!)
        # í˜„ì¬ ì™€ì¼ë“œì¹´ë“œ(*) ì„¤ì •ì€ í…ŒìŠ¤íŠ¸ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©
        # í”„ë¡œë•ì…˜ì—ì„œëŠ” ë°˜ë“œì‹œ íŠ¹ì • ë„ë©”ì¸ìœ¼ë¡œ ì œí•œí•´ì•¼ í•¨
        # ì˜ˆ: add_header Access-Control-Allow-Origin "https://yourdomain.com";
        add_header Access-Control-Allow-Origin "http://localhost:3000";
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization";
        
        # ê°œë°œ í™˜ê²½ì—ì„œ ì¶”ê°€ ì˜¤ë¦¬ì§„ í—ˆìš© (í•„ìš”ì— ë”°ë¼ ì£¼ì„ í•´ì œ)
        # add_header Access-Control-Allow-Origin "http://localhost:3001" always;
        # add_header Access-Control-Allow-Origin "http://localhost:3002" always;
        # add_header Access-Control-Allow-Origin "http://localhost:3004" always;
        
        # Shell App (ë©”ì¸ ì»¨í…Œì´ë„ˆ) - ë£¨íŠ¸ì—ì„œ ì„œë¹™
        location / {
            root /usr/share/nginx/html/shell;
            try_files $uri $uri/ /index.html;
            
            # Module Federationì„ ìœ„í•œ JS íŒŒì¼ ìºì‹œ ì„¤ì •
            location ~* \.js$ {
                expires 1h;
                add_header Cache-Control "public, immutable";
            }
        }
        
        # Remote1 ë§ˆì´í¬ë¡œì•±
        location /remote1/ {
            root /usr/share/nginx/html;
            try_files $uri $uri/ /remote1/index.html;
            
            # remoteEntry.jsëŠ” ìºì‹œí•˜ì§€ ì•ŠìŒ
            location = /remote1/remoteEntry.js {
                root /usr/share/nginx/html;
                expires 0;
                add_header Cache-Control "no-cache, no-store, must-revalidate";
            }
        }
        
        # Remote2 ë§ˆì´í¬ë¡œì•±
        location /remote2/ {
            root /usr/share/nginx/html;
            try_files $uri $uri/ /remote2/index.html;
            
            # remoteEntry.jsëŠ” ìºì‹œí•˜ì§€ ì•ŠìŒ
            location = /remote2/remoteEntry.js {
                root /usr/share/nginx/html;
                expires 0;
                add_header Cache-Control "no-cache, no-store, must-revalidate";
            }
        }
        

        
        # Auth Frontend ì•± 
        location /auth/ {
            alias /usr/share/nginx/html/auth-frontend/;
            try_files $uri $uri/ /auth/index.html;
        }
        
        # Auth Server API (Next.js ì„œë²„ë¡œ í”„ë¡ì‹œ)
        location /api/ {
            proxy_pass http://auth-server:3003;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
            
            # ê°œë°œ í™˜ê²½ - localhost ì˜¤ë¦¬ì§„ë“¤ë§Œ í—ˆìš©
            add_header Access-Control-Allow-Origin "http://localhost:3000";
            add_header Access-Control-Allow-Credentials true;
            
            # í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ì•„ë˜ì™€ ê°™ì´ ì‹¤ì œ ë„ë©”ì¸ ì‚¬ìš©
            # add_header Access-Control-Allow-Origin "https://yourdomain.com";
            # add_header Access-Control-Allow-Credentials true;
            
            # OPTIONS í”„ë¦¬í”Œë¼ì´íŠ¸ ìš”ì²­ ì²˜ë¦¬
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin "http://localhost:3000";
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
                add_header Access-Control-Allow-Headers "Content-Type, Authorization";
                add_header Access-Control-Allow-Credentials true;
                add_header Content-Length 0;
                add_header Content-Type text/plain;
                return 204;
            }
        }
        
        # ì •ì  íŒŒì¼ë“¤ (ì´ë¯¸ì§€, í°íŠ¸ ë“±) - JS íŒŒì¼ ì œì™¸
        location ~* \.(jpg|jpeg|png|gif|ico|css|woff|woff2|ttf|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}
